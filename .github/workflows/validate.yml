name: Validate Jekyll Site

on:
  push:
    branches: [ main, feature/* ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  validate:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        lfs: false  # Set to true when Git LFS is enabled
    
    - name: Set up Ruby
      uses: ruby/setup-ruby@v1
      with:
        ruby-version: '3.1'
        bundler-cache: true
    
    - name: Install dependencies
      run: |
        gem install bundler
        bundle install || echo "No Gemfile found, installing Jekyll manually"
        gem install jekyll
        gem install jekyll-feed
        gem install jekyll-seo-tag
    
    - name: Validate Jekyll configuration
      run: |
        if [ -f "_config.yml" ]; then
          echo "‚úÖ _config.yml found"
          cat _config.yml
        else
          echo "‚ùå _config.yml not found"
          exit 1
        fi
    
    - name: Check required directories
      run: |
        dirs="_includes/widgets _layouts assets/css examples docs"
        for dir in $dirs; do
          if [ -d "$dir" ]; then
            echo "‚úÖ $dir exists"
          else
            echo "‚ùå $dir missing"
            exit 1
          fi
        done
    
    - name: Validate widget files
      run: |
        widgets="video-widget.html audio-widget.html obsidian-widget.html tile-layout.html"
        for widget in $widgets; do
          if [ -f "_includes/widgets/$widget" ]; then
            echo "‚úÖ $widget exists"
          else
            echo "‚ùå $widget missing"
            exit 1
          fi
        done
    
    - name: Validate layout files
      run: |
        layouts="default.html onboarding.html"
        for layout in $layouts; do
          if [ -f "_layouts/$layout" ]; then
            echo "‚úÖ $layout exists"
          else
            echo "‚ùå $layout missing"
            exit 1
          fi
        done
    
    - name: Validate CSS files
      run: |
        css_files="style.css widgets.css"
        for css in $css_files; do
          if [ -f "assets/css/$css" ]; then
            echo "‚úÖ $css exists"
          else
            echo "‚ùå $css missing"
            exit 1
          fi
        done
    
    - name: Build Jekyll site
      run: |
        bundle exec jekyll build --trace || jekyll build --trace
      env:
        JEKYLL_ENV: production
    
    - name: Check build output
      run: |
        if [ -d "_site" ]; then
          echo "‚úÖ Site built successfully"
          echo "üìä Build statistics:"
          find _site -type f | wc -l
          du -sh _site
        else
          echo "‚ùå Build failed - no _site directory"
          exit 1
        fi
    
    - name: Validate HTML (basic check)
      run: |
        if command -v tidy &> /dev/null; then
          find _site -name "*.html" -exec tidy -q -e {} \; || echo "HTML validation warnings found"
        else
          echo "‚ö†Ô∏è tidy not available, skipping HTML validation"
        fi
    
    - name: Check for broken internal links (basic)
      run: |
        echo "üîç Checking for common link issues..."
        if grep -r "href=\"\"" _site/*.html 2>/dev/null; then
          echo "‚ö†Ô∏è Found empty href attributes"
        fi
        echo "‚úÖ Basic link check complete"
    
    - name: Verify Git LFS configuration
      run: |
        if [ -f ".gitattributes" ]; then
          echo "‚úÖ .gitattributes found"
          cat .gitattributes
        else
          echo "‚ö†Ô∏è .gitattributes not found"
        fi
        
        if [ -f ".lfsconfig" ]; then
          echo "‚úÖ .lfsconfig found"
          cat .lfsconfig
        else
          echo "‚ö†Ô∏è .lfsconfig not found"
        fi
    
    - name: Check documentation
      run: |
        if [ -f "docs/ONBOARDING.md" ]; then
          echo "‚úÖ ONBOARDING.md exists"
          wc -l docs/ONBOARDING.md
        else
          echo "‚ùå ONBOARDING.md missing"
          exit 1
        fi
    
    - name: Summary
      if: success()
      run: |
        echo "================================================"
        echo "‚úÖ All validation checks passed!"
        echo "================================================"
        echo "üìã Checklist:"
        echo "  ‚úÖ Jekyll configuration valid"
        echo "  ‚úÖ All required directories present"
        echo "  ‚úÖ All widget files present"
        echo "  ‚úÖ All layout files present"
        echo "  ‚úÖ CSS files present"
        echo "  ‚úÖ Site builds successfully"
        echo "  ‚úÖ Documentation present"
        echo "================================================"
